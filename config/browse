#!/bin/sh
cd ~/web

# outbound proxy on default port
export https_proxy=https://localhost:8080
export  http_proxy=http://localhost:8080
mitmdump -p 8080 &

# reverse proxy on default and high port
mitmdump -p 443 -m reverse:http://localhost:8000 --set keep_host_header=true &
mitmdump -p 8888 -m reverse:http://localhost:8000 --set keep_host_header=true &

# daemon
unicorn -p 8000 -o localhost .conf/rack.ru

# direct hosts to outbound or reverse proxy as appropriate
su -c 'iptables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner 10095 --dport 443 -j REDIRECT --to-ports 8888'
export no_proxy=m,l,localhost,*.weather.com,*.npttech.com,*.nbcuni.com,*.queryly.com,tru.am,*.akamaihd.net,*.nbcudigitaladops.com,*.evidon.com,*.intellitxt.com,*.ai,*.wsi.com,*.anvato.net,*.babator.com,*.tubemogul.com,*.mg2connext.com,*.pagefair.com,rpxnow.com,*.db-ip.com,*.msecnd.net,*.janrain.com,*.windows.net,*.visualstudio.com,*.azurewebsites.net,*.petametrics.com,*.adroll.com,*.trbas.com,*.trb.com,*.tribdss.com,*.solidopinion.com,*.dianomi.com,*.arcpublishing.com,*.msn.com,*.microsoft.com,*.myfinance.com,*.bankrate.com,*.addthisedge.com,*.addthis.com,*.mktoresp.com,*.marketo.com,*.ipify.org,*.adobedtm.com,*.jquery.com,*.and.co.uk,*.yldbt.com,*.assettype.com,*.accuweather.com,*.matheranalytics.com,*.lightboxcdn.com,*.omnitagjs.com,*.fxcompared.com,*.adkernel.com,*.cwkuki.com,*.adblade.com,*.powerlinks.com,*.idealmedia.com,bttrack.com,*.metadsp.co.uk,*.zqtk.net,*.postrelease.com,*.dowjoneson.com,*.tiqcdn.com,*.unrulymedia.com,*.tru.am,*.vidora.com,*.micpn.com,*.survata.com,*.w.org,getrockerbox.com,ml314.com,*.newscgp.com,*.snapchat.com,*.ncaudienceexchange.com,*.cxense.com,*.relaymedia.com,ritogaga.com,lockerdome.com,*.bzgint.com,*.revstripe.com,*.poratav.com,*.rs-stripe.com,*.afy11.net,*.hotjar.com,*.lockerdome.com,*.swiftypecdn.com,*.rhythmxchange.com,*.mediawallahscript.com,*.pulpix.com,*.3lift.com,*.sonobi.com,bluetoad.com,*.exelator.com,*.swiftype.com,*.crazyegg.com,*.mzbcdn.net,*.pingdom.net,*.mezzobit.com,*.skimresources.com,*.pgmcdn.com,*.instinctiveads.com,*.brightcovecdn.com,*.zergnet.com,*.boltdns.net,*.gvt2.com,*.gvt3.com,*.brightcove.net,*.brightcove.com,*.jwplatform.com,*.adreadytractions.com,*.media,*.gravatar.com,*.adready.com,*.brealtime.com,*.crashlytics.com,onesignal.com,udmserve.net,*.addroplet.com,*.liadm.com,*.brightspotcdn.com,*.moatads.com,*.lijit.com,*.clickability.com,*.turn.com,*.cint.com,*.crwdcntrl.net,*.cloud,*.dynamicyield.com,*.tremorhub.com,*.connatix.com,*.dynamicyield.com,*.conviva.com,*.sail-horizon.com,*.civicscience.com,*.lphbs.com,*.go.com,*.comodo.net,*.sail-personalize.com,*.theplatform.com,*.jsdelivr.net,*.fwmrm.net,*.omtrdc.net,*.netdna-ssl.com,*.htvapps.com,*.paypalobjects.com,*.typekit.net,*.cloudinary.com,*.iheart.com,*.viafoura.co,*.viafoura.net,*.ampproject.org,storify.com,*.pubmatic.com,*.wordpress.com,*.wp.com,*.tv,*.vuukle.com,*.izooto.com,*.report-uri.com,*.ravenjs.com,*.optmnstr.com,*.edgekey.net,*.btserve.com,*.qlitics.com,*.eproof.com,*.mplxtms.com,*.intermarkets.net,*.cdnjquery.com,ad-delivery.net,*.clicktale.net,*.flipboard.com,*.admantx.com,*.auth0.com,*.segment.com,*.rubiconproject.com,*.consumertrack.com,*.consensu.org,*.iperceptions.com,*.sharethis.com,*.zemanta.com,*.truste.com,*.trustarc.com,*.ensighten.com,*.sharethrough.com,*.beemray.com,*.deepintent.com,*.livefyre.com,*.demdex.net,*.mfadsrvr.com,*.yieldmo.com,*.agkn.com,*.gigya.com,*.taboola.com,*.imrworldwide.com,*.mathtag.com,*.zencdn.net,nxtck.com,*.linksynergy.com,*.rlcdn.com,*.dpmsrv.com,*.adsnative.com,*.adnxs.com,*.revcontent.com,*.optimizely.com,*.bluekai.com,*.everesttech.net,*.userzoom.com,*.tronc.com,*.casalemedia.com,*.indexww.com,*.krxd.net,*.parrable.com,*.researchnow.com,*.rtb123.com,*.zipalerts.com,*.nile.works,*.nr-data.net,*.lineageos.org,*.mail.ru,*.mozilla.com,*.mozilla.net,*.mozilla.org,*.go-mpulse.net,*.bounceexchange.com,*.parsely.com,*.pinterest.com,*.pinimg.com,*.keywee.co,*.adsafeprotected.com,*.newrelic.com,*.betrad.com,*.doubleverify.com,*.2mdn.net,*.advertising.com,*.blueconic.net,*.boomtrain.com,*.3gl.net,*.chartbeat.com,*.chartbeat.net,*.criteo.com,*.criteo.net,*.openx.net,*.trustx.org,*.bkrtx.com,*.appboy.com,*.adjust.com,*.tinypass.com,*.quantcast.com,*.quantcount.com,*.quantserve.com,*.scorecardresearch.com,*.outbrain.com,*.outbrainimg.com,*.marfeel.com,*.newsinc.com,*.myfonts.net,*.crashlytics.com,*.moatads.com,*.stackadapt.com,*.yimg.com,*.eyeota.net,*.quora.com,*.quoracdn.net,*.vox-cdn.com,*.voxmedia.com,*.amazon-adsystem.com,*.amazonaws.com,*.adsrvr.org,*.spot.im,*.kargo.com,*.bidswitch.net,*profitrumour.com,*.contextweb.com,*.feedbackify.com,*.digitru.st,*.adsymptotic.com,*.newsmaxfeednetwork.com,*.twitter.com,t.co,*.ads-twitter.com,abs.twimg.com,*.linkedin.com,*.cloudfront.net,*.io,*.bing.com,*.yahoo.com,justicejudo.com,*.facebook.com,*.fb.com,*.facebook.net,*.amazon.com,github.com,*.github.com,*.eccmp.com,*.media.net,*.cloudflare.com,*.disqus.com,*.doubleclick.net,*.google.com,*.googleadservices.com,*.googletagmanager.com,*.googletagservices.com,google-analytics.com,*.google-analytics.com,*.googleapis.com,*.gstatic.com,*.googlesyndication.com,*.typography.com,*.gobankingrates.com,*.fastly.net,*.t-mobile.com,*.sstatic.net,*.bootstrapcdn.com
