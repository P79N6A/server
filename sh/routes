#!/bin/sh

# abstract port-enabling methods
open_port=$(realpath $1/sh/open_port)
open_TCP=$(realpath $1/sh/open_TCP)
open_UDP=$(realpath $1/sh/open_UDP)

# open required ports
$open_TCP 22 # SSH
$open_TCP 43 # WHOIS
$open_port 53 # DNS
$open_port 67 # DHCP
$open_port 68 # DHCP
$open_TCP 80   # HTTP
iptables  -t nat -A OUTPUT -p tcp -m owner ! --uid-owner $2 --dport  80 -j REDIRECT --to-ports 8000 # ipv4 to daemon on high-port
ip6tables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner $2 --dport  80 -j REDIRECT --to-ports 8000 # ipv6 to daemon on high-port
$open_TCP 443  # HTTPS
iptables  -t nat -A OUTPUT -p tcp -m owner ! --uid-owner $2 --dport 443 -j REDIRECT --to-ports 8080 # ipv4 to reverse-proxy on high-port
ip6tables -t nat -A OUTPUT -p tcp -m owner ! --uid-owner $2 --dport 443 -j REDIRECT --to-ports 8080 # ipv6 to reverse-proxy on high-port
$open_TCP 3128 # forward HTTPS proxy
$open_TCP 8000 # local HTTP daemon
$open_TCP 8022 # SSH
$open_TCP 8080 # reverse HTTPS proxy
$open_UDP 60001 # Mosh

# log and drop remaining packets
iptables  -N LOG4
ip6tables -N LOG6
iptables  -A OUTPUT -j LOG4
ip6tables -A OUTPUT -j LOG6
iptables  -A LOG4 -m limit -j LOG --log-prefix "IP4 " --log-level 4
ip6tables -A LOG6 -m limit -j LOG --log-prefix "IP6 " --log-level 4
iptables  -A LOG4 -j DROP
ip6tables -A LOG6 -j DROP
iptables  -P INPUT DROP
ip6tables -P INPUT DROP
iptables  -P OUTPUT DROP
ip6tables -P OUTPUT DROP
