#!/bin/sh
app=$(realpath ~/src/pw)

# session handle
base=$(realpath ~/web)
cd $base
tmux new-session -s web -d -c $base

# network config
uid=$(id -u)
su -c "sh $app/sh/routes $uid $app/sh"

# local daemon
tmux send-keys -t web:0 'unicorn -N -l 0.0.0.0:80 -l [::1]:80 -l 0.0.0.0:8000 -l [::1]:8000 .conf/rack.ru' C-m

# HTTPS frontend
squid -f $app/config/squid.conf
tmux new-window -t web:1 -d $app/sh/access_log

# data sync
tmux new-window -t web:2 -d watch -n 28888 rsync -av $DATAPEER:web/`date +%Y/%m` ~/web/`date +%Y`

# control
tmux attach-session -t web
