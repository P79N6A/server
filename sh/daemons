#!/bin/sh
# user-scoped ruby-env
export GEM_HOME=$HOME
export PATH=$PATH:$HOME/bin

# initialize session
tmux new-session -s web -d -c ~/web

# configure network
su -c /data/data/com.termux/files/home/src/pw/sh/routes

# HTTP in
tmux send-keys  -t web:0   'unicorn  -p 8000 -o localhost .conf/rack.ru' C-m
tmux new-window -t web:1 -d mitmdump -p 8888 -m reverse:http://localhost:8000 --set keep_host_header=true

# HTTP out
tmux new-window -t web:2 -d mitmdump -m upstream:http://m:8080 --set keep_host_header=true --ssl-insecure

# database synchronization
tmux new-window -t web:3 -d
tmux send-keys -t web:3 "watch -n 288 rsync -av $DATAPEER:web/`date +%Y/%m/%d` ~/web/`date +%Y/%m`" C-m

# user input
tmux attach-session -t web
