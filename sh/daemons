#!/bin/sh
# IN is a proxy in front of the local daemon (aka 'reverse')
# OUT is a proxy to inspect/log traffic heading to the internet

# browser requests go OUT unless earmarked to IN with an entry in <../config/proxy.domains>
# cache-oblivious apps also goes IN via routing rules. useful for inspecting hidden "phone home" traffic

# other scripts:
# 'proxyhosts' to output hosts-pattern for environment var NO_PROXY or paste into OS-managed proxy config
# 'browse' to launch a browser configured with 'proxyhosts' output

# initialize session
tmux new-session -s web -d -c ~/web

# configure routing
proxy_uid=$(id -u)
routeconfig=$(realpath ~/src/pw/sh/routes)
su -c "sh $routeconfig $proxy_uid"

# start daemon
tmux send-keys -t web:0 'unicorn -N -p 8000 -o localhost .conf/rack.ru' C-m

# HTTP (IN)
tmux new-window -t web:1 -d mitmdump -p 8888 -m reverse:http://localhost:8000 --set keep_host_header=true

# HTTP (OUT)
tmux new-window -t web:2 -d mitmdump

# database synchronization
tmux new-window -t web:3 -d
tmux send-keys -t web:3 "watch -n 288 rsync -av $DATAPEER:web/`date +%Y/%m/%d` ~/web/`date +%Y/%m`" C-m

# user input
tmux attach-session -t web
