#!/usr/bin/env ruby

$stdout.sync = true
$stderr.sync = true

%w{thin ww}.map{|l| require l}

module Rack
  module Adapter
    def self.guess _; :rack end
    def self.load _ # inline the handler-code
      Rack::Builder.new {
        use Rack::Deflater
        run R
      }.to_app
    end
  end
end

case ARGV[0]
when 'to_ssl'
  ARGV.shift
  ARGV.unshift *%w{-p 80}
  R::GET['/'] = -> d,e {[301,{'Location' => "https://"+e['SERVER_NAME']+e['REQUEST_URI']},[]]}
when 'ssl'
  ARGV.shift
  ARGV.unshift *%w{--ssl -p 443 --ssl-key-file /etc/ssl/localcerts/server.key --ssl-cert-file /etc/ssl/localcerts/server.crt}
else
  ARGV.unshift *%w{-p 80}
end
ARGV.unshift *%w{--threaded}

unless ARGV[-1].match /(start|stop|restart|config|install)/
  ARGV.push 'start'
end

Thin::Runner.new(ARGV).run!
