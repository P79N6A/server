#!/usr/bin/env ruby
exit 0 if ARGV.empty?
require 'ww/constants'
begin
  uri = R[ARGV[0]]
  r = R[uri.to_s.sub(/\?#{uri.query}$/,'')]
  r.setEnv({
    'QUERY_STRING' => uri.query,
    'REQUEST_PATH' => r.pathSegment.to_s,
    'REQUEST_URI' => uri.pathSegment.to_s,
    'SERVER_NAME' => r.host,
    :Response => {}}.extend Th)
  out = r.send *ARGV[1..-1]
  if out.class==Array && out.size==3 && out[0].class == Fixnum
    require 'thin'
    response = Thin::Response.new
    response.status, response.headers, response.body = *out
    response.each do |part|
      puts part
    end
  else
    puts out
  end
rescue Exception => e
 puts e.class, e.message, e.backtrace
end
